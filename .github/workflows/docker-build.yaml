name: Docker Build (GCP Handshake)

# This workflow connects GitHub to Google Cloud Build.
# It doesn't build the images on GitHub; it tells Google to do it.

on:
  push:
    branches: [main]       # Trigger on every push to the main branch if files in these paths change:
    paths:                
      - 'src/**'          
      - 'dockerfiles/**'  
      - 'pyproject.toml'  
      - 'cloudbuild.yaml'
      - '.gcloudignore'
  workflow_dispatch:      # Allows us to run it manually from the "Actions" tab

jobs:
  trigger-gcp-build:
    runs-on: ubuntu-latest
    steps:
      # 1. Get the code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Log in to Google Cloud
      - name: Auth with GCP
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}

      # 3. Get the 'gcloud' command ready
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 4. Install uv and pull data (so Cloud Build has the files it needs)
      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Pull data & models (DVC)
        run: |
          uv run dvc pull

      # 5. The "Handshake"
      # This command sends the current folder to GCP and says "Follow the recipe in cloudbuild.yaml"
      - name: Submit build to GCP
        run: |
          gcloud builds submit . --config cloudbuild.yaml
